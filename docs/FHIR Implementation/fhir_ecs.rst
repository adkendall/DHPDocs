Health & Care Information Service FHIR Implementation
==========================================

.. figure:: ../../img/EcsBusService.png
   :scale: 50 %
   :alt: Health & Care Information Service

Figure 1: Health & Care Information Service

The Health and Care Information service enables citizens to view a copy of their data which is held by the health and care services. This is a view-only service and does not provide the ability to push amendments back to the feeding system.

Currently the technical capability exists to provide a copy of Allergy and Medications information from ECS. This uses a FHIR `Composition <http://hl7.org/fhir/DSTU2/composition.html>`__ with contained `AllergyIntolerence <http://hl7.org/fhir/DSTU2/allergyintolerance.html>`__ and `MedictionStatement <http://hl7.org/fhir/DSTU2/medicationstatement.html>`__ resources. 

For a business level description of the forms service see section "*Health & Care Information Business Service*" of this documentation.


FHIR Profiles
-------------

FHIR Profiles have been created and are available to download from this page. The
Access Control Engine (ACE) in the PHF uses the profile, which must be
specified in metadata, to make access control decisions based on scopes
contained within the OAuth2 Access Token. In the current implementation scope **phfapi.admin** 
is required to perform any CRUD operation on health and care information.

DhpEcsMedicalRecord
~~~~~~~~~~~~~~~~~~~

**FHIR Profile:** :download:`https://digitalhealthplatform.scot/fhir/DhpEcsMedicalRecord <Profiles/DhpEcsMedicalRecord.structuredefinition.xml>`

**Base Fhir Resource:** http://hl7.org/fhir/DSTU2/composition.html

**Description**: DhpEcsMedicalRecord is a profile based upon the Composition resource and is used to give structure to the contained resources (MedicationStement and AllergyIntolerence) to provide service users with a view of their summary record as known to their GP.

.. figure:: ../../img/DhpEcsMedicalRecord_forge.png
   :scale: 75 %
   :alt: DhpEcsMedicalRecord Element Tree

Figure2: DhpEcsMedicalRecord Element Tree

The following table is a `differential
statement <http://hl7.org/fhir/DSTU2/profiling.html#snapshot>`__ which
describes only the elements which have been modified from the base
profile. For a full description of all elements see also the FHIR
`Composition <http://hl7.org/fhir/DSTU2/composition.html>`__ structure
definition.

+-----------------------------------+---------------------------------------------------------------------+
| **Attribute**                     | **Notes**                                                           |
+===================================+=====================================================================+
| subject                           | Subject is mandatory and must reference a Patient                   |
|                                   | resource                                                            |
+-----------------------------------+---------------------------------------------------------------------+
| type                              | Type must be a fixed string? TODO: Requires clarification           |
+-----------------------------------+---------------------------------------------------------------------+
| description                       | Human-readable description of the source document. This is sometimes|
|                                   | known as the "title". A description must be specified, either       |
|                                   | manually entered by staff or generated by middleware.               |
+-----------------------------------+---------------------------------------------------------------------+
| securityLabel                     | profiled out                                                        |
+-----------------------------------+---------------------------------------------------------------------+


**FHIR Interactions**

+-----------------------+-----------------------+-----------------------+
| **Scope**             | **Interactions**      | **Constraints**       |
+=======================+=======================+=======================+
| phfapi.admin          | create, read          | none                  |
+-----------------------+-----------------------+-----------------------+

Usage Scenarios
---------------

Create Correspondence
~~~~~~~~~~~~~~~~~~~~~

+-----------------------------------+---------------------------------------------------------------------------+
| Actor                             | Organisation                                                              |
+-----------------------------------+---------------------------------------------------------------------------+
| Interaction                       | POST {fhir base}/DocumentReference                                        |
+-----------------------------------+---------------------------------------------------------------------------+
| Mandatory Requirements            | 1) ``https://digitalhealthplatform.scot/fhir/DhpCorrespondenceDocument``  | 
|                                   |    included in meta.profile                                               |
|                                   |                                                                           |
|                                   | 2) subject = Patient who is the subject of the correspondence             |
|                                   |                                                                           |
|                                   | 3) status = 'current'                                                     |
|                                   |                                                                           |
|                                   | 4) type specified                                                         |
|                                   |                                                                           |
|                                   | 5) Human-readable description set                                         |
|                                   |                                                                           |
|                                   | 6) At least one content element with an attachment containing either      |
|                                   |    the actual base64-cocoded data or a uri where the data can be found    |
|                                   |                                                                           |
|                                   | 7) inform-subject meta tag added                                          |
|                                   |    as per Notifications Service                                           |
|                                   |    profile                                                                |
+-----------------------------------+---------------------------------------------------------------------------+
| Optional                          | 1) Any attributes inherited                                               |
|                                   |    from the base resource which                                           |
|                                   |    have not been profiled out.                                            |
+-----------------------------------+---------------------------------------------------------------------------+

Read
~~~~

+-----------------------------------+-----------------------------------------------------------------------+
| Actor                             | Citizen                                                               |
+-----------------------------------+-----------------------------------------------------------------------+
| Interaction                       | GET {fhir base}/DocumentReference/id                                  |
+-----------------------------------+-----------------------------------------------------------------------+
| Comments                          | Used when the id of the DocumentReference is known,                   |
|                                   | probably by performing a search operation prior to this call.         |    
+-----------------------------------+-----------------------------------------------------------------------+

Search
~~~~~~

+-----------------------------------+---------------------------------------------------------------------------------+
| Actor                             | Citizen                                                                         |
+-----------------------------------+---------------------------------------------------------------------------------+
| Interaction                       | GET {fhir base}/DocumentReference                                               |
+-----------------------------------+---------------------------------------------------------------------------------+
| Parameters                        | _profile=``https://digitalhealthplatform.scot/fhir/DhpCorrespondenceDocument``  |
|                                   | subject={PHF id of subject's Patient resource}                                  |
+-----------------------------------+---------------------------------------------------------------------------------+
| Comments                          | Used to return all correspondence for a patient.                                |
+-----------------------------------+---------------------------------------------------------------------------------+

Profile List
------------

:download:`https://digitalhealthplatform.scot/fhir/DhpCorrespondenceDocument <Profiles/DhpCorrespondenceDocument.structuredefinition.xml>`

Download Forge from https://simplifier.net/forge/download to view this profile.

Examples
--------

.. code-block:: json

 {
        "resourceType": "DocumentReference",
        "id": "spark10",
        "meta": {
          "versionId": "spark61",
          "lastUpdated": "2018-03-02T11:15:16.864+00:00",
          "profile": [
            "https://digitalhealthplatform.scot/fhir/DhpCorrespondenceDocument"
          ],
          "tag": [
            {
              "system": "https://digitalhealthplatform.scot/fhir/tags",
              "code": "subject-informed"
            }
          ]
        },
        "subject": {
          "reference": "https://phfapi.ppedigitalhealthplatform.net/fhir/Patient/spark10"
        },
        "created": "2018-01-08T10:53:08.6119632Z",
        "indexed": "2018-01-08T10:53:08.611+00:00",
        "status": "current",
        "description": "Emergency Discharge Letter - Cardiology",
        "content": [
          {
            "attachment": {
              "contentType": "application/pdf",
              "data": "<base64-encoded string>",
              "title": "Emergency Discharge Letter - Cardiology"
            }
          }
        ]
      }


C# Examples
-------------------------

.. code-block:: c#

            DocumentReference docref = new DocumentReference
            {
                Description = "SampleCA Letter. This letter has not been viewed.",
                Indexed = DateTime.Now,
                Created = new FhirDateTime(DateTime.Now).Value,
                Status = DocumentReferenceStatus.Current,
                Meta = new Meta() { Tag = new List<Coding>() { new Coding() { Code = "inform-subject", System = "https://digitalhealthplatform.scot/fhir/tags" } } },
                Content = new List<DocumentReference.ContentComponent>
                {
                    new DocumentReference.ContentComponent { Attachment = new Attachment { Data = GetExampleLetterPDF(), ContentType = "application/pdf", Title = "SampleCA Letter" } }
                },
                Subject = new ResourceReference { Reference = string.Format(CultureInfo.CurrentCulture, "Patient/{0}", GetPatientSparkId()) }
            };
